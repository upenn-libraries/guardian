version: '3.1'

secrets:
  db_secrets:
    file: 'secrets/db.secret'
  glacier_secrets:
    file: 'secrets/glacier.secret'
  guardian_secrets:
    file: 'secrets/guardian.secret'
  bulwark_gitannex_secrets:
    file: 'secrets/bulwark_gitannex.secret'
  bulwark_rsa:
    external: true
services:
  db:
    image: 'guardian_db:5.7'
    secrets:
      - db_secrets
    volumes:
      - 'db:/var/lib/mysql'
  guardian:
    image: 'guardian:latest'
    depends_on:
      - 'db'
    secrets:
      - db_secrets
      - glacier_secrets
      - guardian_secrets
      - bulwark_gitannex_secrets
      - source: bulwark_rsa
        target: /root/.ssh/bulwark_rsa
        mode: 0600
    volumes:
      - 'guardian:/usr/src/app'
      - 'guardian_todos:/todos'
      - '${LOCAL_ZIP_WORKSPACE}:/zip_workspace'
      - '${LOCAL_LOG_FILE}:/usr/src/app/logs'
volumes:
  db:
  guardian:
  guardian_todos:
